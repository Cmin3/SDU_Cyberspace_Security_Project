# SM4算法实现与优化项目

## 一、项目概述

本项目实现了中国商用密码标准SM4算法的多种优化版本，包括基础实现、T-table优化、SSE2指令优化以及GCM工作模式实现。通过不同层次的优化技术，显著提升了SM4算法的执行效率，满足高性能密码应用场景的需求。

## 二、算法原理详解

### 1. SM4基础算法

SM4是一种分组密码算法，主要特点包括：
- 分组长度：128位
- 密钥长度：128位
- 轮数：32轮
- 使用非线性S盒和线性变换L函数

核心运算流程：
1. **密钥扩展**：将128位主密钥扩展为32个轮密钥
2. **轮函数**：每轮包含异或、S盒替换和线性变换
3. **加解密**：32轮迭代后反序输出

### 2. 优化技术

#### T-table优化
- 预计算S盒与线性变换的组合结果
- 将4次查表合并为1次查表操作
- 减少轮函数中的计算量

#### SSE2指令优化
- 使用SIMD指令并行处理4个数据块
- 减少循环次数和分支预测
- 利用128位寄存器提高吞吐量

#### GCM工作模式
- 结合CTR模式加密和GHASH认证
- 提供加密和认证一体化功能
- 使用Galois域乘法实现高效认证

## 三、文件说明

### 核心实现文件

1. `sm4_base.cpp`：SM4基础实现
   - 标准轮函数实现
   - 基本密钥扩展算法
   - 参考级实现

2. `sm4_table.cpp`：T-table优化实现
   - 预计算T0-T3表
   - 查表优化轮函数
   - 提升约30%性能

3. `sm4_aes.cpp`：SSE2指令优化
   - 使用SIMD指令处理4个块
   - 批量加密优化
   - 进一步提升并行性

4. `sm4_gcm.cpp`：GCM工作模式实现
   - SM4-CTR加密
   - GHASH认证算法
   - 完整GCM功能

## 四、运行结果

性能测试结果（1000次运算）：

| 实现方式     | 总耗时(μs) | 平均耗时(μs/次) |
| ------------ | ---------- | --------------- |
| 基础实现     | 3184.20    | 3.18            |
| T-table优化  | 2001.74    | 2.00            |
| SSE2优化     | 1275.11    | 1.27            |
| SM4-GCM(64B) | 43010.52   | 43.01           |

## 五、构建与运行

### 编译指令

```bash
# 基础版本
g++ -O3 sm4_base.cpp -o sm4_base

# T-table优化
g++ -O3 sm4_table.cpp -o sm4_table

# SSE2优化
g++ -O3 -msse2 sm4_aes.cpp -o sm4_aes

# GCM模式
g++ -O3 sm4_gcm.cpp -o sm4_gcm
```

### 运行测试

```bash
./sm4_base
./sm4_table
./sm4_aes
./sm4_gcm
```

## 六、实现特点

1. **高性能**：
   - T-table优化减少计算量
   - SIMD指令提升并行性
   - 算法级优化与指令级优化结合

2. **完整性**：
   - 包含基础实现和多种优化
   - 实现GCM认证加密模式
   - 覆盖典型应用场景

3. **可扩展性**：
   - 模块化设计便于扩展
   - 支持进一步指令集优化
   - 可集成到更大系统

4. **正确性**：
   - 严格遵循SM4标准
   - 包含完整测试验证
   - 确保各版本结果一致
